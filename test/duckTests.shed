package duck;

import hat.TestResult;
import hat.TestCase;
import hat.assertTrue;
import hat.assertFalse;
import hat.assertEquals;
import hat.results.all;
import duck;
import duck.Matcher;
import duck.equalTo;

public val duckTests = listOf(
    TestCase("equalTo matches using equals method", fun() => do {
        return testMatcher(duck.equalTo[String]("blah"), listOf(
            description("\"blah\""),
            positive[String]("blah"),
            negative[String]("Blah", mismatchDescription("was \"Blah\""))
        ));
    }),
    
    TestCase("isList matches if lists are same length and all elements match", fun() => do {
        val list = listOf(equalTo[String]("apple"), equalTo[String]("banana"));
        return testMatcher(duck.isList[String](list), listOf(
            description("listOf(\"apple\", \"banana\")"),
            positive[List[String]](listOf("apple", "banana")),
            negative[List[String]](listOf(), mismatchDescription("list was of length 0")),
            negative[List[String]](
                listOf("apple", "coconut"),
                mismatchDescription("element at index 1 did not match:\n  was \"coconut\"\n  expected \"banana\"")
            )
        ));
    }),
    
    TestCase("anything always matches", fun() =>
        testMatcher(duck.anything, listOf(
            description("<anything>"),
            positive[Unit](listOf("apple", "banana"), "apple", (), false, 5)
        ))
    )
);

def testMatcher fun(matcher: Matcher[T], assertions: List[Func[Matcher[T], TestResult]]) : TestResult =>
    all(assertions.map(fun(assertion: MatcherAssertion) => assertion(matcher)));

def description fun(expectedDescription: String) =>
    fun(matcher: Matcher[Nothing]) =>
        assertEquals[String](expectedDescription, matcher.describeSelf())

def positive fun[T] => (positiveValue: T) =>
    fun(matcher: Matcher[T]) =>
        assertTrue(matcher.matches(positiveValue))

def negative fun[T] => (negativeValue: T, mismatchDescription: String) =>
    fun(matcher: Matcher[T]) => all(listOf(
        assertFalse(matcher.matches(negativeValue)),
        assertEquals[String](mismatchDescription, matcher.describeMismatch(negativeValue))
    ))

def mismatchDescription fun(description: String) => description
